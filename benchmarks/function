#!/usr/bin/perl

use Time::HiRes;
use strict;

######################################################################

my $HOME         = "/home/ubuntu";
my $FUNCTION_DIR = "$HOME/function";
my $BENCHES_DIR  = "$HOME/fptprove/benchmarks/function_pcsp";
my $r;
my $BENCHES = {
    bubblesort => '', # (default)
    cacm2009a  => '',
    # https://github.com/caterinaurban/function/blob/master/tests/cacm2009b.c
    cacm2009b => '-ordinals 1 -joinbwd 3',
    # https://github.com/caterinaurban/function/blob/master/tests/cav2006.c
    cav2006 => '-joinbwd 3',
    # https://github.com/caterinaurban/function/blob/master/tests/example10.c
    example10 => '-ordinals 2 -joinbwd 3',
    # https://github.com/caterinaurban/function/blob/master/tests/example1.c
    example1 => '', 
    # https://github.com/caterinaurban/function/blob/master/tests/example8.c
    example8 => '-joinbwd 7',
    sas2010 => '',
    sorting4 => '-domain octagons', # (or polyhedra)
    tacas2013a => '',
    tacas2013b => '-domain octagons',
    tacas2013c => '-joinbwd 3 -ordinals 3',
    tacas2013d => '-joinbwd 3 -ordinals 2',
    vmcai2004a => '-joinbwd 5'
};

######################################################################

foreach my $b (keys %{$BENCHES}) {

    # extract the C code and RF type
    open IN, "$BENCHES_DIR/$b.clp" or die "$! -- $BENCHES_DIR/$b.clp";
    open OUT, ">$BENCHES_DIR/$b.c" or die $!;
    my $begin = 0;
    my $kind = $BENCHES->{$b};
    while(<IN>) {
	     #if (m/requires lexicog/) { $kind = '-ordinals 50'; }
	     if ($begin == 1 && m/\*\)/) { last; }
       elsif ($begin == 0 && m/\(\*/) { $begin = 1; }
	     else { print OUT $_; }
    }
    close IN;
    close OUT;
    print "did $b - type is $kind.\n";

    # run the benchmark
    my $start = Time::HiRes::gettimeofday();
    my $res = qx{$FUNCTION_DIR/Main.native $BENCHES_DIR/$b.c -termination $kind};
    my $end = Time::HiRes::gettimeofday();
    print $res;
    printf("TIME: %.3f s\n", $end-$start);
    my $output = 'unparsed';
    if ($res =~ /Analysis Result: ([A-Z]+)/) { $output = $1; }
    $r->{$b}->{time}   = $end-$start;
    $r->{$b}->{output} = $output;
    $r->{$b}->{kind}   = $kind;
}
use Data::Dumper;
print Dumper($r);

foreach my $b (keys %{$BENCHES}) {
    printf("%-12s & %-15s & %-10s & %0.3f \\\\\n", $b, $r->{$b}->{kind}, $r->{$b}->{output}, $r->{$b}->{time});
}
